---
title: 企业微信开发第三方H5应用开发
tags:
  - javascript
date: 2020-07-01
permalink: 2020-07-01-work-wechat-third-app-development
---

## 前言

因业务需要, 需要将我们的系统与企业微信进行对接, 折腾了好一阵, 总算告一段落, 总结起来就两个字: 麻烦

- 开发工具: 烂, 不能使用移动端模式, 不能设置 debugger, 一设置就整个企业微信卡死
- 移动端应用居然不给我选择移动端适配?
- 配置麻烦, 尤其是每次修改之后都要进行重新安装(针对我们的业务), 简直是噩梦!!

## 概念理清

官方的开发需知一定要认真读, 理清基本的概念

1. 企业内部应用和第三方应用
2. 上线和上架

## 快速开始

作为一个前端, 如何准备哪些东西, 方便快速开始自己的项目呢?

除了看官方文档的[快速入门](https://work.weixin.qq.com/api/doc/90001/90142/90595), 这里总结了下流程,

### 创建一个企业微信账户

你所在企业作为第三方应用服务商开发应用, 开发完成需要另外一个企业作为使用方使用你的应用, 为了方便测试, 最好的方法是

以你的账号申请一个企业, 用来安装应用进行测试, 最好创建两个, 一个作为 dev 和 staging 环境, 另外一个 production 环境用
v

### 创建应用

需要你所在企业的企业管理员扫码登录[企业微信服务商后台](https://open.work.weixin.qq.com/wwopen/developer#/index), 在应用管理那里选择-> 创建项目, 之后在应用主页设置各种配置信息

### 可信域名与内网穿透

由于企业微信的第三方 H5 应用需要配置可信域名, 而本地开发地址显然是无法通过企业微信的域名校验的, 解决的方法是使用`内网穿透`, 原理感兴趣可以自行搜索,简单而言就是可以把你的`本地localhost的服务映射到公网的地址`, 以花生壳为例,会自动分配一个域名给你, `xxxxxxx.oicp.vip`, 配置好穿透之后, 将对应的域名填上去就好了.

在配置好穿透之后, 在 public 文件夹放置校验文件, 只要你能够通过`xxxxxxx.oicp.vip/MEkcNmXU1TXwd0eZ.txt`访问到该文件就行, 线上部署,每次 build 项目的时候, 也需要添加相应的校验文件

```js
"build": "npm run build:h5 && npm run verify",
"verify": "echo 'MEkcNmXU1TXwd0eZ' > dist/build/h5/WW_verify_MEkcNmXU1TXwd0eZ.txt",
```

### 设置各种回调

这步需要后端人员的配合, 只有这步走完之后才能够进行测试

### 本地开发与安装调试

#### 安装

当前端项目初始化完成, 后端回调配置 ok 之后, 就可以尝试安装了, 具体看[文档](https://work.weixin.qq.com/api/doc/90001/90142/90595)

安装完成之后使用你的测试企业, 进入应用管理, 点开相关的应用, 进行配置, 比如可见范围设置所有开发人员可见

#### 调试

企业微信内部可以启用[开发者模式](https://work.weixin.qq.com/api/doc/90000/90139/90315#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B0%83%E8%AF%95)

- mac: ctrl + command + shift + D

然后右键点击-> 审查元素即可

但是有几点坑的地方:

1. 别加 debugger, 会直接卡死
2. 无法使用移动端模拟器, 如 iphone6

### 接入授权

因为我们是 H5 应用, 需要走网页授权拿到用户的身份信息, 参考[网页授权登录](https://work.weixin.qq.com/api/doc/90001/90143/91118)

### 接入 sdk

签名会比较麻烦, 主要是后端处理

### 总结

走完上面几步, 基本的开发步骤就算走完了, 接下来是真正的需求实现, 期间也遇到不少坑, 想到再补吧

## 踩坑汇总

1. 企业微信应用主页和可信域名变更是否会影响已安装用户的使用

对于线上环境：提交发布之后会立即将应用主页和可信域名会生效

对于安装测试：

- 主页更改: 除非进行二次安装测试, 否则更改就会影响安装测试的用户
- 可信域名: 只要更改了, 所有的测试环境都会受到影响

[参见](https://developers.weixin.qq.com/community/develop/doc/00026856ff0f68dd867a0220056800?highline=%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E7%AC%AC%E4%B8%89%E6%96%B9H5%E5%BA%94%E7%94%A8%EF%BC%8C%E4%BF%AE%E6%94%B9%E5%BA%94%E7%94%A8%E4%B8%BB%E9%A1%B5%E5%90%8E%E4%B8%8D%E7%94%9F%E6%95%88)

要吐槽的地方就在这里, 由于业务系统需要对接很多合作伙伴, 导致需要后端配合才能完成一次安装, 并不是前端简单点击一个安装测试的按钮就可以了, 前期不熟悉导致需要后台多次配合安装, 如果有类似情况的小伙伴要注意!

建议添加三个测试企业, 一个是 dev, 一个是 staging, 最后一个是 production

- 应用主页可以拿到 corpid=\$CORPID

- 如果使用了家校通, 应用有普通的 h5, 并且有消息推送...

因为我们的 H5 应用此前对接了很多平台，而作为企业微信第三方 H5 应用使用的，接入的是企业微信的家校通，所以就要考虑以下情况

- 家长从微信打开普通的 H5, 需要走的微信的授权
- (企业微信通讯录同步的)家长从微信打开家校通入口，找到我的学校，在我的学校里面打开 H5, 需要走的是企业微信的授权
- 企业微信的推送通知, 需要走的是企业微信授权
- (企业微信通讯录同步的)老师从企业微信打开，需要走的是企业微信的授权

问题来了: 无法通过判断 userAgent 的形式判断是需要走微信的授权,还是企业微信授权, 因此需要传递某些特定的参数, 如`system=workwechat`

2. 企业微信 40029 状态码报错: 不合法的 oauth_code

原因一: 微信出现两次重定向, 而两次携带的都是相同的 code, 第一次使用之后 code 就失效了
解决: 添加`connect_redirect=1`字段到链接中

```js
const redirectUrl = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=wwa8575b53d140807a&redirect_uri=${process.env.VUE_APP_WORKWECHAT_REDIRECT_ENDPOINT}%2Fpages%2Flogin%2Fwork-wechat&response_type=code&scope=snsapi_userinfo&state=normal&connect_redirect=1#wechat_redirect`;

window.location.href = redirectUrl;
```

原因二: 构造链接中的 appid 没有填写正确

检查构造的 redirectUrl 中的 appid 和 secret 是否填写正确，由于我们的应用有两个，为教师端和家长端，测的时候匆忙，错把家长端的 appid 当成了学校端的

3. 家长微信端打开域名被禁掉了

由于花生壳的域名被用烂了, 因此容易被微信封禁掉, 没有其他的办法, 只能叫后台给一个登录的 token, 自己本地开发完之后, 上传到测试环境调试
